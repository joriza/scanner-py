<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Pro - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <nav>
        <a href="/" class="active">Dashboard</a>
        <a href="/admin">Administración</a>
    </nav>

    <div class="container">
        <h1>Dashboard de Señales Técnicas</h1>

        <div class="controls">
            <select id="strategySelect"
                style="background: var(--card-bg); color: var(--text-main); border: 1px solid var(--accent); padding: 0.75rem; border-radius: 0.5rem; cursor: pointer;">
                <option value="rsi_macd">Estrategia 1: RSI + MACD</option>
                <option value="3_emas">Estrategia 2: 3 EMAS (Diaria + Semanal)</option>
            </select>
            <button id="refreshBtn">Actualizar Precios</button>
            <button id="scanBtn" class="secondary">Escanear Indicadores</button>
            <button id="exportBtn" style="background: #27ae60; color: white;">Exportar a Excel</button>
            <span id="loader" class="loading-spinner">Procesando...</span>
        </div>

        <div class="card">
            <table id="mainTable">
                <thead id="tableHead"></thead>
                <tbody id="signalTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const loader = document.getElementById('loader');
        const refreshBtn = document.getElementById('refreshBtn');
        const scanBtn = document.getElementById('scanBtn');
        const exportBtn = document.getElementById('exportBtn');
        const tableBody = document.getElementById('signalTable');
        const tableHead = document.getElementById('tableHead');
        const strategySelect = document.getElementById('strategySelect');

        async function loadSignals() {
            loader.style.display = 'inline';
            const strategy = strategySelect.value;
            try {
                const response = await fetch(`/api/scan?strategy=${strategy}`);
                const data = await response.json();
                renderTable(data, strategy);
            } catch (error) {
                console.error('Error:', error);
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderTable(data, strategy) {
            tableBody.innerHTML = '';

            if (strategy === 'rsi_macd') {
                tableHead.innerHTML = `
                    <tr>
                        <th>Símbolo</th>
                        <th>Precio</th>
                        <th>RSI(14)</th>
                        <th>RSI < 30 (1año)</th>
                        <th>Tendencia RSI</th>
                        <th>MACD Opp (30d)</th>
                        <th>Ult. Sync</th>
                    </tr>
                `;
                data.sort((a, b) => {
                    if (a.days_since_rsi_bullish === null && b.days_since_rsi_bullish === null) return 0;
                    if (a.days_since_rsi_bullish === null) return 1;
                    if (b.days_since_rsi_bullish === null) return -1;
                    return a.days_since_rsi_bullish - b.days_since_rsi_bullish;
                });
            } else if (strategy === '3_emas') {
                tableHead.innerHTML = `
                    <tr>
                        <th>Símbolo</th>
                        <th>Precio</th>
                        <th>EMA 4(D)</th>
                        <th>EMA 9(D)</th>
                        <th>EMA 18(D)</th>
                        <th>3 EMAS Diaria</th>
                        <th>3 EMAS Semanal</th>
                        <th>Ult. Sync</th>
                    </tr>
                `;
                data.sort((a, b) => {
                    const scoreA = (a.emas_d_active ? 1 : 0) + (a.emas_w_active ? 1 : 0);
                    const scoreB = (b.emas_d_active ? 1 : 0) + (b.emas_w_active ? 1 : 0);
                    if (scoreA !== scoreB) return scoreB - scoreA;
                    const wA = a.emas_w_days !== null ? a.emas_w_days : 9999;
                    const wB = b.emas_w_days !== null ? b.emas_w_days : 9999;
                    if (wA !== wB) return wA - wB;
                    const dA = a.emas_d_days !== null ? a.emas_d_days : 9999;
                    const dB = b.emas_d_days !== null ? b.emas_d_days : 9999;
                    return dA - dB;
                });
            }

            data.forEach(s => {
                const row = document.createElement('tr');
                if (strategy === 'rsi_macd') {
                    let macdContent = 'No';
                    let macdClass = 'signal-no';
                    if (s.macd_status === 'active') {
                        macdContent = `${s.macd_date} (${s.macd_days} d)`;
                        macdClass = 'signal-yes';
                    } else if (s.macd_status === 'inactive') {
                        macdContent = `${s.macd_date} (${s.macd_days} d)`;
                        macdClass = 'signal-no';
                    }

                    row.innerHTML = `
                        <td style="font-weight: 600">${s.symbol}</td>
                        <td>$${s.price.toFixed(2)}</td>
                        <td>${s.rsi ? s.rsi.toFixed(2) : '-'}</td>
                        <td>
                            <span class="signal ${s.days_since_rsi_30 !== null ? 'signal-yes' : 'signal-no'}">
                                ${s.days_since_rsi_30 !== null ? `Hace ${s.days_since_rsi_30} d (${s.date_rsi_30})` : 'Sin Sobreventa'}
                            </span>
                        </td>
                        <td>
                            <span class="signal ${s.days_since_rsi_bullish !== null ? 'signal-yes' : 'signal-no'}">
                                ${s.days_since_rsi_bullish !== null ? `${s.date_rsi_bullish} (${s.days_since_rsi_bullish} d)` : 'N/A'}
                            </span>
                        </td>
                        <td><span class="signal ${macdClass}">${macdContent}</span></td>
                        <td>${s.last_sync}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td style="font-weight: 600">${s.symbol}</td>
                        <td>$${s.price.toFixed(2)}</td>
                        <td>${s.ema4_d ? s.ema4_d.toFixed(2) : '-'}</td>
                        <td>${s.ema9_d ? s.ema9_d.toFixed(2) : '-'}</td>
                        <td>${s.ema18_d ? s.ema18_d.toFixed(2) : '-'}</td>
                        <td>
                            <span class="signal ${s.emas_d_active ? 'signal-yes' : 'signal-no'}">
                                ${s.emas_d_date ? `${s.emas_d_date} (${s.emas_d_days} d)` : 'No'}
                            </span>
                        </td>
                        <td>
                            <span class="signal ${s.emas_w_active ? 'signal-yes' : 'signal-no'}">
                                ${s.emas_w_date ? `${s.emas_w_date} (${s.emas_w_days} d)` : 'No'}
                            </span>
                        </td>
                        <td>${s.last_sync}</td>
                    `;
                }
                tableBody.appendChild(row);
            });
        }

        exportBtn.addEventListener('click', () => {
            const strategyName = strategySelect.options[strategySelect.selectedIndex].text;
            const now = new Date();
            const timestamp = now.toLocaleDateString().replace(/\//g, '-') + '_' + now.getHours() + '-' + now.getMinutes();
            const fileName = `${strategyName}_${timestamp}.xlsx`;

            const table = document.getElementById("mainTable");
            const workbook = XLSX.utils.table_to_book(table);
            XLSX.writeFile(workbook, fileName);
        });

        refreshBtn.addEventListener('click', async () => {
            loader.style.display = 'inline';
            try { await fetch('/api/refresh', { method: 'POST' }); await loadSignals(); } finally { loader.style.display = 'none'; }
        });
        scanBtn.addEventListener('click', loadSignals);
        strategySelect.addEventListener('change', loadSignals);
        loadSignals();
    </script>
</body>

</html>